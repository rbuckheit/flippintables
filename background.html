<script>

/* 
  MODELS

  Node: { 
    "url": "http://www.google.com",
    "title": "Google",
    "favicon": "http://www.google.com/favicon.ico",
    "created_at": "<dateTime>"
  }
  
  Link: {
    "src": <src_index_in_list>,
    "dest": <dest_index_in_list>
  }

*/

  var nodes = new Array();
  var links = new Array();

  // listen for messages from content scripts
  chrome.extension.onRequest.addListener(
    function(request, sender, sendResponse) {
      console.log(sender.tab ? "from page content script:" + sender.tab.url : "from extension");
      console.log("command: " + request.cmd);
      var respond = true;
      
      if (request.cmd == "add_link") {
        // TODO: error conditions -- duplicate links, etc.
        if (request.src != request.dest) {
          var src_id = loadNode(request.src);
          var dest_id = loadNode(request.dest);
          links.push({"src": src_id, "dest": dest_id});
          console.log("ADD LINK: " + nodeToString(nodes[src_id]) + " => " + nodeToString(nodes[dest_id]));
        }
      } 
      
      else if (request.cmd == "node_info") {
        var favicon = request.favicon;
        var title = request.title;
        var date= new Date().getTime();
        var node = nodes[loadNode(request.url)];
        console.log("NODE INFO [" + node.url + "] " + favicon + " " + title + " timestamp " + date);
        node.title = title
        node.favicon = favicon
        printNodes();
      }
      
      else {
        respond = false
      }
      
      if(respond) 
        sendResponse({cmd: "ack"});
      else
        sendResponse({});

  });
  
  /*
  chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
      console.log("TAB CHANGE HAPPENED");
  });*/
  
  /*=======
   * NODES 
   *======*/
  
  // load node with specified url. creates node if it doesn't exist.
  // returns index in the nodes list
  function loadNode(url) {
    var target = null;
    
    // search list
    for (i = 0; i < nodes.length; i += 1) {
      var node = nodes[i];
      if (node.url == url) {
        return i;
      }
    }
    
    // create if not found
    if (target == null) {
      console.log("node not found. creating...");
      target = {"url": url}
      nodes.push(target);
      return nodes.length - 1;
    }
  }
  
  function nodeToString(node) {
    return "\t[url=" + node.url + ", title=" + node.title + ", favicon=" + node.favicon  + "]";
  }
  
  // print contents of nodes list.
  function printNodes() {
    console.log("NODES:");
    for (i = 0; i < nodes.length; i += 1)
      console.log(nodeToString(nodes[i]));
  }
  
  /*=======
   * LINKS
   *======*/
  


</script>
