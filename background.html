<script>

/* 
  MODELS

  Node: { 
    "url": "http://www.google.com",
    "title": "Google",
    "favicon": "http://www.google.com/favicon.ico",
    "created_at": "<dateTime>"
  }
  
  Link: {
    TODO
  }

*/

  var nodes = new Array();
  var links = new Array();

  // listen for messages from content scripts
  chrome.extension.onRequest.addListener(
    function(request, sender, sendResponse) {
      console.log(sender.tab ? "from page content script:" + sender.tab.url : "from extension");
      console.log("command: " + request.cmd);
      var respond = true;
      
      if (request.cmd == "add_link") {
        var src = request.src;
        var dest = request.dest;
        links.push()
        console.log("Add link for: " + src + " => " + dest);
      } 
      
      else if (request.cmd == "node_info") {
        var favicon = request.favicon;
        var title = request.title;
        var node = loadNode(request.url);
        console.log("Node info [" + node.url + "] " + favicon + " " + title);
        node.title = title
        node.favicon = favicon
        printNodes();
        // TODO 
      }
      
      else {
        respond = false
      }
      
      if(respond) 
        sendResponse({cmd: "ack"});
      else
        sendResponse({});

  });
  
  // load node with specified url. creates node if it doesn't exist
  function loadNode(url) {
    var target = null;
    
    // search list
    for (i = 0; i < nodes.length; i += 1) {
      var node = nodes[i];
      if (node.url == url) {
        target = node;
      }
    }
    
    // create if not found
    if (target == null) {
      console.log("node not found. creating...");
      target = {"url": url}
      nodes.push(target);
    }
    printNodes();
    return target;
  }
  
  // print contents of nodes list.
  function printNodes() {
    console.log("NODES:");
    for (i = 0; i < nodes.length; i += 1) {
      var node = nodes[i];
      console.log("\t[url=" + node.url + ", title=" + node.title + ", favicon=" + node.favicon  + "]");
    }
  }
  
  chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
      console.log("TAB CHANGE HAPPENED");
  });

</script>
